# i18n Architecture

## Scope

- Supported locales: `en`, `nl`
- Locale source of truth: URL prefix (`/en/...`, `/nl/...`)
- Locale fallback order: `bf_locale` cookie -> `Accept-Language` -> `en`

## Core Files

- `src/proxy.ts`: locale redirect/rewrite + localized auth redirect
- `src/i18n/proxyDecision.ts`: pure routing decision logic
- `src/i18n/config.ts`: locale constants and negotiation helpers
- `src/i18n/navigation.ts`: locale path utilities
- `src/i18n/switchHref.ts`: query-preserving language-switch href helper
- `src/i18n/getDictionary.ts`: server-side dictionary loader
- `src/i18n/messages/en.ts`: source-of-truth translation shape
- `src/i18n/messages/nl.ts`: Dutch catalog (`satisfies typeof en`)
- `src/i18n/metadata.ts`: canonical/hreflang alternates builder

## Request Lifecycle

1. User hits unprefixed route (`/about` or `/`).
2. Proxy resolves preferred locale and redirects to prefixed route (`/nl/about`).
3. Prefixed route is rewritten internally to existing App Router path (`/about`).
4. Locale is passed through header `x-bf-locale` and reflected in `<html lang>`.
5. Locale cookie `bf_locale` is synced on localized requests.

## Adding Translation Keys

1. Add key(s) in `src/i18n/messages/en.ts`.
2. Mirror key(s) in `src/i18n/messages/nl.ts`.
3. Use dictionary value from server component (preferred) and pass text props to client components.
4. Run validation:
   - `npm run test -- src/i18n/messages/messages-parity.test.ts`
   - `npm run typecheck`

## Localization QA Checklist

1. Open `/` with browser language `nl`; verify redirect to `/nl`.
2. Open `/` with cookie `bf_locale=en`; verify redirect to `/en`.
3. On homepage language switch:
   - switch EN -> NL on deep path (`/en/about?tab=fit`) and verify `/nl/about?tab=fit`
   - switch NL -> EN and verify path/query are preserved.
4. Verify localized dashboard auth redirect:
   - unauthenticated `/nl/dashboard` -> `/nl/login`
   - unauthenticated `/en/dashboard` -> `/en/login`
5. Verify `<html lang>` updates for both locales.
6. Verify canonical/hreflang metadata for localized public pages.
